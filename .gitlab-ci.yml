image: "liuchong/rustup:1.18.0"

before_script:
  - dpkg --add-architecture i386
  - apt-get update -yqq && apt-get install  -yqq libudev-dev pkg-config git libgcc1:i386 libudev1:i386
  - git submodule sync
  - git submodule update --init
  - rustc -Vv && cargo -Vv

cache:
  paths:
    - /root/.cargo
    - /root/.rustup
    - target

build:x86_64-unknown-linux-gnu:
  stage: build
  script:
    - cargo test --no-run --verbose

test:x86_64-unknown-linux-gnu:
  stage: test
  script:
    - cargo test --verbose

build:i686-unknown-linux-gnu:
  stage: build
  variables:
    PKG_CONFIG_ALLOW_CROSS: 1
  before_script:
    - dpkg --add-architecture i386
    - apt-get update -yqq && apt-get install  -yqq libudev-dev pkg-config git libgcc1:i386 libudev1:i386
    - git submodule sync
    - git submodule update --init
    - rustc -Vv && cargo -Vv
    - rustup target add i686-unknown-linux-gnu
  script:
    - cargo test --no-run --verbose --target=i686-unknown-linux-gnu

test:i686-unknown-linux-gnu:
  stage: test
  script:
    - cargo test --verbose --target=i686-unknown-linux-gnu

pages:
  stage: deploy
  script:
  - cargo doc
  # Remove libc from documentation to speed up deploy
  - rm -r target/doc/libc
  - rm -r target/doc/src/libc
  - mkdir public
  - mkdir public/img
  - mv target/doc public
  - mv controller.svg public/img/
  artifacts:
    expire_in: 1 week
    paths:
      - public
  only:
    - master
